<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Trabajo - PreetyTaxi</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --gold: #ffc107; --dark: #121212; --card: #1e1e1e; --green: #28a745; --blue: #4285F4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; margin: 0; padding: 15px; }
        .header { background: var(--card); padding: 20px; border-radius: 15px; border-bottom: 4px solid var(--gold); margin-bottom: 20px; text-align: center; }
        .header h2 { margin: 0; color: var(--gold); font-size: 22px; }
        .status-bar { display: flex; justify-content: space-around; background: #222; padding: 10px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; border: 1px solid #333; }
        .viaje-card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-aceptar { background: var(--green); color: white; }
        .btn-maps { background: white; color: #444; }
        .btn-finalizar { background: var(--blue); color: white; }
        .btn-cancelar { background: #dc3545; color: white; font-size: 12px; }
    </style>
</head>
<body>

    <div class="header">
        <h2 id="txtNombre">Identificando...</h2>
        <p id="txtPlaca" style="color:#bbb; margin-top:5px; font-size: 14px;">Cargando veh√≠culo...</p>
    </div>

    <div class="status-bar">
        <span>üü¢ Conectado</span>
        <span id="txtCelular">ID: ---</span>
    </div>

    <div id="contenedorViajes">
        <p style="text-align:center; color:#666;">Buscando viajes disponibles...</p>
    </div>

<script>
    // 1. CONFIGURACI√ìN FIREBASE
    const firebaseConfig = { databaseURL: "https://preetytaxiapp-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. RECUPERAR DATOS (Con valores por defecto para evitar el "Cargando...")
    const cCel = localStorage.getItem('choferCel') || "S/N";
    const cNom = localStorage.getItem('choferNombre') || "Conductor";
    const cPla = localStorage.getItem('choferPlaca') || "No asignada";

    // Mostrar en pantalla inmediatamente
    document.getElementById('txtNombre').innerText = "Chofer: " + cNom;
    document.getElementById('txtPlaca').innerText = "Placa: " + cPla;
    document.getElementById('txtCelular').innerText = "ID: " + cCel;

    // 3. ESCUCHAR VIAJES EN TIEMPO REAL
    db.ref('viajes').on('value', snap => {
        const contenedor = document.getElementById('contenedorViajes');
        contenedor.innerHTML = "";
        let hayViajes = false;

        snap.forEach(child => {
            const v = child.val();
            const idV = child.key;

            // Mostrar si el viaje est√° PENDIENTE o si YA LO ACEPT√ì este chofer
            if (v.estado === "pendiente" || (v.estado === "aceptado" && v.choferId === cCel)) {
                hayViajes = true;
                const card = document.createElement('div');
                card.className = "viaje-card";

                if (v.estado === "pendiente") {
                    card.innerHTML = `
                        <p style="color:var(--gold); font-weight:bold;">üöï NUEVO PEDIDO</p>
                        <p><b>Pasajero:</b> ${v.cliente || 'Anonimo'}</p>
                        <p><b>Recoger en:</b> ${v.puntoA || 'No indicada'}</p>
                        <p><b>Destino:</b> ${v.puntoB || 'No indicado'}</p>
                        <p style="font-size:20px; color:var(--green);"><b>Tarifa: $${v.precio || '0.00'}</b></p>
                        <button class="btn btn-aceptar" onclick="actualizarViaje('${idV}', 'aceptado')">ACEPTAR VIAJE</button>
                    `;
                } else {
                    card.style.borderLeftColor = "var(--blue)";
                    card.innerHTML = `
                        <p style="color:var(--blue); font-weight:bold;">‚úÖ VIAJE EN CURSO</p>
                        <p><b>Cliente:</b> ${v.cliente}</p>
                        <p><b>Ubicaci√≥n:</b> ${v.puntoA}</p>
                        <button class="btn btn-maps" onclick="abrirRuta('${v.puntoA}')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/aa/Google_Maps_icon_%282020%29.svg" width="18">
                            ABRIR GPS
                        </button>
                        <button class="btn btn-finalizar" style="margin-top:15px;" onclick="actualizarViaje('${idV}', 'completado')">FINALIZAR VIAJE</button>
                        <button class="btn btn-cancelar" onclick="actualizarViaje('${idV}', 'pendiente')">CANCELAR VIAJE</button>
                    `;
                }
                contenedor.appendChild(card);
            }
        });

        if (!hayViajes) {
            contenedor.innerHTML = '<p style="text-align:center; color:#666; margin-top:40px;">üîç No hay pedidos en este momento.<br><small>Espera a que un cliente pida un taxi.</small></p>';
        }
    });

    function actualizarViaje(id, nuevoEstado) {
        db.ref('viajes/' + id).update({
            estado: nuevoEstado,
            choferId: (nuevoEstado === 'pendiente' ? null : cCel),
            choferNombre: (nuevoEstado === 'pendiente' ? null : cNom),
            choferPlaca: (nuevoEstado === 'pendiente' ? null : cPla)
        });
    }

    function abrirRuta(destino) {
        if (!destino) return alert("Ubicaci√≥n no disponible");
        window.open("https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(destino), '_blank');
    }
</script>
</body>
</html>