<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel de Trabajo - PreetyTaxi</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --gold: #ffc107; --dark: #121212; --card: #1e1e1e; --green: #28a745; --blue: #4285F4; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--dark); 
            color: white; 
            margin: 0; 
            padding: 15px;
            touch-action: manipulation; /* Evita zoom accidental */
        }
        .header { background: var(--card); padding: 20px; border-radius: 15px; border-bottom: 4px solid var(--gold); margin-bottom: 20px; text-align: center; }
        .header h2 { margin: 0; color: var(--gold); font-size: 22px; }
        .status-bar { display: flex; justify-content: space-around; background: #222; padding: 10px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; border: 1px solid #333; }
        .viaje-card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-aceptar { background: var(--green); color: white; }
        .btn-maps { background: white; color: #444; }
        .btn-finalizar { background: var(--blue); color: white; }
        .btn-cancelar { background: #dc3545; color: white; font-size: 13px; padding: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <h2 id="txtNombre">Identificando...</h2>
        <p id="txtPlaca" style="color:#bbb; margin-top:5px; font-size: 14px;">Cargando veh√≠culo...</p>
    </div>

    <div class="status-bar">
        <span>üü¢ Conectado</span>
        <span id="txtCelular">ID: ---</span>
    </div>

    <div id="contenedorViajes">
        <p style="text-align:center; color:#666;">Buscando viajes disponibles...</p>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://preetytaxiapp-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const cCel = localStorage.getItem('choferCel') || "S/N";
    const cNom = localStorage.getItem('choferNombre') || "Conductor";
    const cPla = localStorage.getItem('choferPlaca') || "No asignada";

    document.getElementById('txtNombre').innerText = "Chofer: " + cNom;
    document.getElementById('txtPlaca').innerText = "Placa: " + cPla;
    document.getElementById('txtCelular').innerText = "ID: " + cCel;

    db.ref('viajes').on('value', snap => {
        const contenedor = document.getElementById('contenedorViajes');
        contenedor.innerHTML = "";
        let hayViajes = false;

        snap.forEach(child => {
            const v = child.val();
            const idV = child.key;

            if (v.estado === "pendiente" || (v.estado === "aceptado" && v.choferId === cCel)) {
                hayViajes = true;
                const card = document.createElement('div');
                card.className = "viaje-card";

                if (v.estado === "pendiente") {
                    card.innerHTML = `
                        <p style="color:var(--gold); font-weight:bold;">üöï NUEVO PEDIDO</p>
                        <p><b>Pasajero:</b> ${v.cliente || 'An√≥nimo'}</p>
                        <p style="font-size:20px; color:var(--green);"><b>Tarifa: $${v.precio || '0.00'}</b></p>
                        <button class="btn btn-aceptar" onclick="actualizarViaje('${idV}', 'aceptado')">ACEPTAR VIAJE</button>
                    `;
                } else {
                    card.style.borderLeftColor = "var(--blue)";
                    // Guardamos las coordenadas para el GPS
                    const lat = v.origen_coords.lat;
                    const lng = v.origen_coords.lng;
                    
                    card.innerHTML = `
                        <p style="color:var(--blue); font-weight:bold;">‚úÖ VIAJE EN CURSO</p>
                        <p><b>Cliente:</b> ${v.cliente}</p>
                        <button class="btn btn-maps" onclick="abrirGoogleMaps(${lat}, ${lng})">
                            üìç IR A RECOGER (GPS)
                        </button>
                        <button class="btn btn-finalizar" style="margin-top:15px;" onclick="actualizarViaje('${idV}', 'completado')">FINALIZAR VIAJE</button>
                        <button class="btn btn-cancelar" onclick="actualizarViaje('${idV}', 'pendiente')">SOLTAR VIAJE</button>
                    `;
                }
                contenedor.appendChild(card);
            }
        });

        if (!hayViajes) {
            contenedor.innerHTML = '<p style="text-align:center; color:#666; margin-top:40px;">üîç No hay pedidos en este momento.<br><small>Espera a que un cliente pida un taxi.</small></p>';
        }
    });

    function actualizarViaje(id, nuevoEstado) {
        db.ref('viajes/' + id).update({
            estado: nuevoEstado,
            choferId: (nuevoEstado === 'pendiente' ? null : cCel),
            choferNombre: (nuevoEstado === 'pendiente' ? null : cNom),
            choferPlaca: (nuevoEstado === 'pendiente' ? null : cPla)
        });
    }

    // Funci√≥n especial para Android: Abre la App de Google Maps instalada
    function abrirGoogleMaps(lat, lng) {
        if (!lat || !lng) return alert("Coordenadas no disponibles");
        // Este formato (geo:) despierta a la App de Maps en Android
        const url = "https://www.google.com/maps/search/?api=1&query=" + lat + "," + lng;
        window.open(url, '_blank');
    }
</script>
</body>
</html>
